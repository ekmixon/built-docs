<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Node.js Agent version 3.x | APM Node.js Agent Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="release-notes.html" title="Release notes"/>
<link rel="prev" href="release-notes.html" title="Release notes"/>
<link rel="next" href="release-notes-2.x.html" title="Node.js Agent version 2.x"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Node.js Agent Reference [master]</a></span>
»
<span class="breadcrumb-link"><a href="release-notes.html">Release notes</a></span>
»
<span class="breadcrumb-node">Node.js Agent version 3.x</span>
</div>
<div class="navheader">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-2.x.html">Node.js Agent version 2.x »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="release-notes-3.x"></a>Node.js Agent version 3.x<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h2>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_unreleased"></a>Unreleased<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<h5><a id="_features"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add instrumentation of all AWS S3 methods when using the
<a href="https://www.npmjs.com/package/aws-sdk" class="ulink" target="_top">JavaScript AWS SDK v2</a> (<code class="literal">aws-sdk</code>).
</li>
<li class="listitem">
Add <a class="xref" href="configuration.html#disable-send" title="disableSend"><code class="literal">disableSend</code></a> configuration option. This supports some
use cases using the APM agent <span class="strong strong"><strong>without</strong></span> an APM server. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2101" class="ulink" target="_top">#2101</a>)
</li>
<li class="listitem">
Add instrumentation of all DynamoDB methods when using the
<a href="https://www.npmjs.com/package/aws-sdk" class="ulink" target="_top">JavaScript AWS SDK v2</a> (<code class="literal">aws-sdk</code>).
</li>
</ul>
</div>
<h5><a id="_bug_fixes"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix inconsistencies in HTTP spans from other APM agents.
<a class="xref" href="span-api.html#span-subtype" title="span.subtype"><code class="literal">span.subtype</code></a> will now be "http" for HTTP, HTTPS, and
HTTP/2 outgoing spans&#8201;&#8212;&#8201;previously it was "http", "https", "http2",
respectively. As well, <a class="xref" href="span-api.html#span-action" title="span.action"><code class="literal">span.action</code></a> will now be the HTTP
method (e.g. "GET", "PUT", "POST"), rather than "http". (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2075" class="ulink" target="_top">#2075</a>)
</li>
<li class="listitem">
Fixed error where SQS messages sent without an active transactions could
crash the agent. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2113" class="ulink" target="_top">#2113</a>)
</li>
<li class="listitem">
Fixed support for proxies in destination context (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1770" class="ulink" target="_top">#1770</a>)
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-x.x.x"></a>3.16.0 - 2021/06/14<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_2"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Added <a class="xref" href="configuration.html#span-frames-min-duration" title="spanFramesMinDuration"><code class="literal">spanFramesMinDuration</code></a>
configuration field, allowing users to set a time threshold value that spans
must reach before the agent will add a stack trace to the span. As a result,
many short spans that previously included stack traces by default no longer
will.
</li>
<li class="listitem">
Prefer W3C "traceparent" header over "elastic-apm-traceparent" for incoming
requests. <a href="https://github.com/elastic/apm-agent-nodejs/pull/2079" class="ulink" target="_top">#2079</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_2"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix a crash (<code class="literal">TypeError: lastPrepareStackTrace</code>) in the agent when used with
React v17 and later (<a href="https://github.com/elastic/apm-agent-nodejs/issues/1980" class="ulink" target="_top">#1980</a>).
</li>
<li class="listitem">
<p>Performance improvements have been made in error and stacktrace capture (<a href="https://github.com/elastic/apm-agent-nodejs/pull/2094" class="ulink" target="_top">#2094</a>).
This also included in two bug fixes:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Before this change, some captured errors (for example a <code class="literal">next(new Error('boom')</code> from
an Express handler) would mark the error as "unhandled" incorrectly. "Unhandled"
exceptions are those caught by an <code class="literal">uncaughtException</code> handler.
</li>
<li class="listitem">
Before this change, source context lines for a stacktrace would not properly
use the "sourcesContext" field of a file&#8217;s source map.
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.15.0"></a>3.15.0 - 2021/05/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_3"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add support for Node.js v16. (This also drops testing of Node.js v13
releases.) <a href="https://github.com/elastic/apm-agent-nodejs/pull/2055" class="ulink" target="_top">#2055</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_3"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Update TypeScript typings for <code class="literal">Agent.setLabel</code> and <code class="literal">Agent.addLabels</code> to
include the <code class="literal">stringify</code> argument that was added in v3.11.0.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.14.0"></a>3.14.0 - 2021/04/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_4"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add <code class="literal">apm.addMetadataFilter(fn)</code> for filtering the
<a href="/guide/en/apm/server/current/metadata-api.html" class="ulink" target="_top">metadata object</a>
sent to APM server.
</li>
<li class="listitem">
<p>The handling of sending events (transactions, spans, errors) to APM server
has improved in a few ways. During temporary spikes in load and/or an APM
server that is unresponsive, the agent will buffer a number of events and
<span class="strong strong"><strong>drop</strong></span> them above a certain limit (configurable via <a class="xref" href="configuration.html#max-queue-size" title="maxQueueSize"><code class="literal">maxQueueSize</code></a>).
This helps ensure the agent does not overly consume memory and CPU. As well,
the agent will now <a href="https://github.com/elastic/apm/blob/master/specs/agents/transport.md#transport-errors" class="ulink" target="_top">backoff</a>
when the APM server errors. Finally, improved error handling means it will
terminate failing requests to the APM server more quickly.</p>
<p>Note: v1 of this agent (EOL&#8217;d 2 years ago), included a <code class="literal">maxQueueSize</code> config
variable with a different meaning. If you have a lingering usage of that
setting (also possibly as the <code class="literal">ELASTIC_APM_MAX_QUEUE_SIZE</code> environment
variable), then it should be removed.</p>
</li>
<li class="listitem">
Adds support for Amazon SQS queues via <code class="literal">aws-sdk</code> instrumentation that
partially implements the <a href="https://github.com/elastic/apm/blob/master/specs/agents/tracing-instrumentation-messaging.md" class="ulink" target="_top">APM messaging spec</a>,
and adds <code class="literal">queue.latency.min.ms</code>, <code class="literal">queue.latency.max.ms</code>, and <code class="literal">queue.latency.avg.ms</code>
metrics for SQS queues.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_4"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fixed bug where the URL property for outgoing HTTP request spans was set
with the server&#8217;s IP address rather than its hostname. The Agent now sets
this property with the actual URL requested by Node.js. <a href="https://github.com/elastic/apm-agent-nodejs/issues/2035" class="ulink" target="_top">#2035</a>
</li>
<li class="listitem">
Fixed bug where external services were not listed under Dependencies on the
APM Service Overview page due to the trace-context propagated <code class="literal">sample_rate</code>
value not being set on either transactions or spans.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.13.0"></a>3.13.0 - 2021/04/06<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_5"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>The APM agent&#8217;s own internal logging now uses structured JSON logging using
the <a href="https://getpino.io/#/docs/api?id=logger" class="ulink" target="_top">pino API</a>, and formatted in
<a href="/guide/en/ecs-logging/overview/master/intro.html" class="ulink" target="_top">ecs-logging</a> format. The log records on stdout
are now single-line JSON objects. For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash"># Before
APM Server transport error (ECONNREFUSED): connect ECONNREFUSED 127.0.0.1:8200

# After
{"log.level":"error","@timestamp":"2021-03-19T00:21:17.571Z","log":{"logger":"elastic-apm-node"},
"ecs":{"version":"1.6.0"},"message":"APM Server transport error (ECONNREFUSED): connect ECONNREFUSED 127.0.0.1:8200"}</pre>
</div>
<p>Pretty formatting (and filtering) on the console may be done via the
<a href="https://github.com/trentm/go-ecslog" class="ulink" target="_top"><code class="literal">ecslog</code></a> tool.</p>
<p>A custom <a class="xref" href="configuration.html#logger" title="logger"><code class="literal">logger</code></a> is still supported as before. However, a non-pino custom
logger will only receive the "message" field, and not structured log fields
as they are added over time.</p>
</li>
<li class="listitem">
Add support for setting the <code class="literal">ELASTIC_APM_LOGGER=false</code> environment variable
to disable/ignore a given custom <a class="xref" href="configuration.html#logger" title="logger"><code class="literal">logger</code></a>. This is to support easier
<a class="xref" href="troubleshooting.html#debug-mode" title="Debug mode">Debug mode</a> for troubleshooting.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_5"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Lock package dependency "elastic-apm-http-client@9.6.0" to avoid using
v9.7.0 for now, because it is breaking tests. A coming release will get back
on the latest of this dependency. <a href="https://github.com/elastic/apm-agent-nodejs/issues/2032" class="ulink" target="_top">#2032</a>
</li>
<li class="listitem">
Remove the "ancestors" field from a log.trace message on startup. Its info
is a duplicate of info in the "startTrace" field in the same log record.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/2005" class="ulink" target="_top">#2005</a>
</li>
<li class="listitem">
Remove the accidental <code class="literal">nodejs.eventloop.delay.ns</code> metric that was always
reporting a zero value. The existing <code class="literal">nodejs.eventloop.delay.avg.ms</code> is
the intended metric. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1993" class="ulink" target="_top">#1993</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.12.1"></a>3.12.1 - 2021/02/25<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_bug_fixes_6"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: Update <a href="https://github.com/elastic/apm-nodejs-http-client/blob/master/CHANGELOG.md#v951" class="ulink" target="_top">apm-server client</a>
to fix a <a href="https://github.com/elastic/apm-agent-nodejs/issues/1749" class="ulink" target="_top">possible crash</a> when polling for central config.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.12.0"></a>3.12.0 - 2021/02/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_6"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: Set span outcome to success or failure depending on whether an error
was captured during when the span was active. <a href="https://github.com/elastic/apm-agent-nodejs/issues/1814" class="ulink" target="_top">#1814</a>
</li>
<li class="listitem">
feat: Adds public <code class="literal">setOutcome</code> method to span and transaction APIs, and
adds a top level <code class="literal">setTransactionOutcome</code> and <code class="literal">setSpanOutcome</code> to set
outcome values for the current active transaction or active span.
</li>
<li class="listitem">
Limit the <code class="literal">transactionSampleRate</code> value to 4 decimal places of precision
according to the shared <a href="https://github.com/elastic/apm/blob/master/specs/agents/tracing-sampling.md#transaction_sample_rate-configuration" class="ulink" target="_top">APM spec</a>. This ensures that propagated sampling rate
in the <code class="literal">tracestate</code> header is short and consistent. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1979" class="ulink" target="_top">#1979</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_7"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: It was possible for fetching central config to result in the
<code class="literal">cloudProvider</code> config value being reset to its default. <a href="https://github.com/elastic/apm-agent-nodejs/issues/1976" class="ulink" target="_top">#1976</a>
</li>
<li class="listitem">
fix: fixes bug where tedious could crash the agent on bulk inserts <a href="https://github.com/elastic/apm-agent-nodejs/pull/1935" class="ulink" target="_top">#1935</a><br>
Reported <a href="https://discuss.elastic.co/t/apm-agent-crashes-nodejs-after-reporting-exception-in-tedious-instrumentation-code/259851" class="ulink" target="_top">via the forum</a>.
The error symptom was: <code class="literal">Cannot read property 'statement' of undefined</code>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.11.0"></a>3.11.0 - 2021/02/08<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_7"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: add <code class="literal">apm.getServiceName()</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1949" class="ulink" target="_top">#1949</a><br>
This will be used by <a href="https://github.com/elastic/ecs-logging-js" class="ulink" target="_top">ecs-logging packages</a>
to integrate with APM.
</li>
<li class="listitem">
feat: support numeric and boolean labels <a href="https://github.com/elastic/apm-agent-nodejs/pull/1909" class="ulink" target="_top">#1909</a><br>
Add an optional <code class="literal">stringify</code> option to <code class="literal">apm.setLabel(name, version, stringify = true)</code>
and <code class="literal">apm.addLabels(labels, stringify = true)</code>, which can be set <code class="literal">false</code> to
allow numeric and boolean labels. Stringify defaults to true for backwards
compatibility&#8201;&#8212;&#8201;stringification will be removed in a future major version.
</li>
<li class="listitem">
feat: added support for cloud metadata fetching <a href="https://github.com/elastic/apm-agent-nodejs/pull/1937" class="ulink" target="_top">#1937</a><br>
Agent now collects information about its cloud environment and includes this
data in the APM Server&#8217;s metadata payload. See
<a href="https://github.com/elastic/apm/blob/3acd10afa0a9d3510e819229dfce0764133083d3/specs/agents/metadata.md#cloud-provider-metadata" class="ulink" target="_top">the spec</a>
for more information.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.10.0"></a>3.10.0 - 2021/01/11<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_8"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: Improve handling of raw body parsing
The agent will now report raw/<code class="literal">Buffer</code> encoded post bodies as <em>&lt;Buffer&gt;</em>.
</li>
<li class="listitem">
feat: Add support for api keys <a href="https://github.com/elastic/apm-agent-nodejs/pull/1818" class="ulink" target="_top">#1818</a><br>
This allows the usage of API keys for authentication to the APM server
</li>
<li class="listitem">
<p>feat: Add automatic instrumentation of the <a href="https://github.com/elastic/elasticsearch-js" class="ulink" target="_top">@elastic/elasticsearch</a> package <a href="https://github.com/elastic/apm-agent-nodejs/pull/1877" class="ulink" target="_top">#1870</a></p>
<p>The instrumentation of the legacy "elasticsearch" package has also changed
slightly to commonalize:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
"span.context.destination" is set on all Elasticsearch spans, not just a
subset of query-like API endpoints.
</li>
<li class="listitem">
For query-like API endpoints (e.g. <code class="literal">/_search</code>), the capturing of query details
on "span.context.db.statement" has changed (a) to include <span class="strong strong"><strong>both</strong></span> the
query params and the request body if both exist (separated by <code class="literal">\n\n</code>) and
(b) to <span class="strong strong"><strong>URL encode</strong></span> the query params, rather than JSON encoding.
</li>
</ul>
</div>
</li>
<li class="listitem">
feat: Add <code class="literal">captureAttributes</code> boolean option to <code class="literal">apm.captureError()</code> to
allow <span class="strong strong"><strong>disabling</strong></span> the automatic capture of Error object properties. This
is useful for cases where those properties should not be sent to the APM
Server, e.g. for performance (large string fields) or security (PII data).
<a href="https://github.com/elastic/apm-agent-nodejs/pull/1912" class="ulink" target="_top">#1912</a>
</li>
<li class="listitem">
feat: Add <code class="literal">log_level</code> central config support. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1908" class="ulink" target="_top">#1908</a><br>
Spec: <a href="https://github.com/elastic/apm/blob/master/specs/agents/logging.md" class="ulink" target="_top">https://github.com/elastic/apm/blob/master/specs/agents/logging.md</a>
</li>
<li class="listitem">
<p>feat: Add <code class="literal">sanitize_field_names</code> configuration option.<br>
Allows users to configure a list of wildcard patterns to <em>remove</em> items
from the agent&#8217;s HTTP header and <code class="literal">application/x-www-form-urlencoded</code> payloads.
<a href="https://github.com/elastic/apm-agent-nodejs/pull/1898" class="ulink" target="_top">#1898</a></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://github.com/elastic/apm/blob/master/specs/agents/sanitization.md" class="ulink" target="_top">spec</a>
</li>
<li class="listitem">
<a href="https://github.com/elastic/apm-agent-nodejs/blob/master/docs/configuration.asciidoc#sanitize-field-names" class="ulink" target="_top">docs</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_8"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>fix: Fix parsing of comma-separated strings for relevant config vars to allow
whitespace around the commas. E.g.:</p>
<pre class="screen">export ELASTIC_APM_TRANSACTION_IGNORE_URLS='/ping, /metrics*'</pre>
<p>Config vars affected are: <code class="literal">disableInstrumentations</code>, <code class="literal">transactionIgnoreUrls</code>
<code class="literal">addPatch</code>, and <code class="literal">globalLabels</code>.</p>
</li>
<li class="listitem">
fix: Correct the environment variable for setting <code class="literal">transactionIgnoreUrl</code>
(added in v3.9.0) from <code class="literal">ELASTIC_TRANSACTION_IGNORE_URLS</code> to
<code class="literal">ELASTIC_APM_TRANSACTION_IGNORE_URLS</code>.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.9.0"></a>3.9.0 - 2020/11/30<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_9"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: support fastify 3 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1891" class="ulink" target="_top">#1891</a><br>
Adds .default and .fastify module.exports to instrumented fastify function
for 3.x line, and prefers req.routerMethod and req.routerPath for
transaction name
</li>
<li class="listitem">
feat: Set "destination" context on spans for "mongodb". <a href="https://github.com/elastic/apm-agent-nodejs/pull/1893" class="ulink" target="_top">#1893</a><br>
This allows Kibana APM Service Maps to show a "mongodb" node for services using
the <a href="https://www.npmjs.com/package/mongodb" class="ulink" target="_top">mongodb</a> package (which includes
mongoose and mongojs).
</li>
<li class="listitem">
feat: transactionIgnoreUrl wildcard matching <a href="https://github.com/elastic/apm-agent-nodejs/pull/1870" class="ulink" target="_top">#1870</a><br>
Allows users to ignore URLs using simple wildcard matching patterns that behave
the same across language agents. See <a href="https://github.com/elastic/apm/issues/144" class="ulink" target="_top">https://github.com/elastic/apm/issues/144</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_9"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: treat set-cookie in response headers as sensitive data <a href="https://github.com/elastic/apm-agent-nodejs/pull/1886" class="ulink" target="_top">#1886</a>
</li>
<li class="listitem">
fix: Synchronous spans would never have <code class="literal">span.sync == true</code>. <a href="https://github.com/elastic/apm-agent-nodejs/pull/1879" class="ulink" target="_top">#1879</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.8.0"></a>3.8.0 - 2020/11/09<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_10"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: expand k8s pod ID discovery regex <a href="https://github.com/elastic/apm-agent-nodejs/pull/1863" class="ulink" target="_top">#1863</a>
</li>
<li class="listitem">
feat: implements tracestate <a href="https://github.com/elastic/apm-agent-nodejs/pull/1828" class="ulink" target="_top">#1828</a><br>
Expands support for the W3C Trace Context specification by adding a tracestate
header implementation, and uses this new header to track the Elastic
transaction sample rate across a trace&#8217;s service boundaries.
</li>
<li class="listitem">
feat: add span and transaction outcome <a href="https://github.com/elastic/apm-agent-nodejs/pull/1824" class="ulink" target="_top">#1824</a><br>
This adds an "outcome" field to HTTP(S)
<a href="https://github.com/elastic/apm/blob/master/specs/agents/tracing-transactions.md#transaction-outcome" class="ulink" target="_top">transactions</a>
and <a href="https://github.com/elastic/apm/blob/master/specs/agents/tracing-spans.md#span-outcome" class="ulink" target="_top">spans</a>.
</li>
</ul>
</div>
<h5><a id="_bug_fixes_10"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(pg): prevent unhandled promise rejection <a href="https://github.com/elastic/apm-agent-nodejs/pull/1846" class="ulink" target="_top">#1846</a>
</li>
<li class="listitem">
fix: redis@2.x instrumentation was broken <a href="https://github.com/elastic/apm-agent-nodejs/pull/1852" class="ulink" target="_top">#1852</a>
</li>
<li class="listitem">
A number of fixes to the test suite.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.7.0"></a>3.7.0 - 2020/8/10<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(knex): add support for 0.21.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1801" class="ulink" target="_top">#1801</a>
</li>
<li class="listitem">
feat(redis): add support for v3.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1641" class="ulink" target="_top">#1641</a>
</li>
<li class="listitem">
feat(graphql): add support for 15.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1795" class="ulink" target="_top">#1795</a>
</li>
<li class="listitem">
feat(koa-router): add support for 9.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1772" class="ulink" target="_top">#1772</a>
</li>
<li class="listitem">
fix(elasticsearch): ensure requests can be aborted <a href="https://github.com/elastic/apm-agent-nodejs/pull/1566" class="ulink" target="_top">#1566</a>
</li>
<li class="listitem">
fix: end span if outgoing http request ends prematurely <a href="https://github.com/elastic/apm-agent-nodejs/pull/1583" class="ulink" target="_top">#1583</a>
</li>
<li class="listitem">
fix: don&#8217;t throw on invalid URL <a href="https://github.com/elastic/apm-agent-nodejs/pull/1771" class="ulink" target="_top">#1771</a>
</li>
<li class="listitem">
fix: patch apollo-server-core &gt; 2.14 correctly <a href="https://github.com/elastic/apm-agent-nodejs/pull/1796" class="ulink" target="_top">#1796</a>
</li>
<li class="listitem">
fix: add currentTraceIds to typings <a href="https://github.com/elastic/apm-agent-nodejs/pull/1733" class="ulink" target="_top">#1733</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.6.1"></a>3.6.1 - 2020/5/20<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(package): bump elastic-apm-http-client to ^9.4.0 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1756" class="ulink" target="_top">#1756</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.6.0"></a>3.6.0 - 2020/5/18<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: add destination metadata for db spans <a href="https://github.com/elastic/apm-agent-nodejs/pull/1687" class="ulink" target="_top">#1687</a>
</li>
<li class="listitem">
feat: add support for Node.js 14 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1742" class="ulink" target="_top">#1742</a>
</li>
<li class="listitem">
feat(pg): add support for pg v8.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1743" class="ulink" target="_top">#1743</a>
</li>
<li class="listitem">
feat: add metrics for external memory <a href="https://github.com/elastic/apm-agent-nodejs/pull/1724" class="ulink" target="_top">#1724</a>
</li>
<li class="listitem">
feat: enrich spans with destination info <a href="https://github.com/elastic/apm-agent-nodejs/pull/1685" class="ulink" target="_top">#1685</a>
</li>
<li class="listitem">
fix(instrumentation): add .js to module path <a href="https://github.com/elastic/apm-agent-nodejs/pull/1711" class="ulink" target="_top">#1711</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.5.0"></a>3.5.0 - 2020/3/9<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(error): get stack trace from Error-like objects <a href="https://github.com/elastic/apm-agent-nodejs/pull/1613" class="ulink" target="_top">#1613</a>
</li>
<li class="listitem">
fix: add logUncaughtExceptions conf option to TypeScript typings <a href="https://github.com/elastic/apm-agent-nodejs/pull/1668" class="ulink" target="_top">#1668</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.4.0"></a>3.4.0 - 2020/2/21<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: support W3C TraceContext traceparent header <a href="https://github.com/elastic/apm-agent-nodejs/pull/1587" class="ulink" target="_top">#1587</a>
</li>
<li class="listitem">
feat: add custom metrics API (experimental) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1571" class="ulink" target="_top">#1571</a>
</li>
<li class="listitem">
feat(koa-router): add support for v8.x <a href="https://github.com/elastic/apm-agent-nodejs/pull/1642" class="ulink" target="_top">#1642</a>
</li>
<li class="listitem">
fix(cassandra): improve support for cassandra-driver v4.4.0+ <a href="https://github.com/elastic/apm-agent-nodejs/pull/1636" class="ulink" target="_top">#1636</a>
</li>
<li class="listitem">
fix: support promisifying setTimeout and friends <a href="https://github.com/elastic/apm-agent-nodejs/pull/1636" class="ulink" target="_top">#1636</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.3.0"></a>3.3.0 - 2019/12/13<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(config): add serverCaCertFile config <a href="https://github.com/elastic/apm-agent-nodejs/pull/1560" class="ulink" target="_top">#1560</a>
</li>
<li class="listitem">
feat(config): add central config support for transactionMaxSpans and captureBody <a href="https://github.com/elastic/apm-agent-nodejs/pull/1555" class="ulink" target="_top">#1555</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.2.0"></a>3.2.0 - 2019/11/19<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix(metrics): only register collectors if enabled <a href="https://github.com/elastic/apm-agent-nodejs/pull/1520" class="ulink" target="_top">#1520</a>
</li>
<li class="listitem">
fix(ioredis): prevent unhandled promise rejection <a href="https://github.com/elastic/apm-agent-nodejs/pull/1523" class="ulink" target="_top">#1523</a>
</li>
<li class="listitem">
chore: add Node 13 to supported engines <a href="https://github.com/elastic/apm-agent-nodejs/pull/1524" class="ulink" target="_top">#1524</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.1.0"></a>3.1.0 - 2019/10/16<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_features_11"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat(mongodb): instrumentation <a href="https://github.com/elastic/apm-agent-nodejs/pull/1423" class="ulink" target="_top">#1423</a>
</li>
<li class="listitem">
fix(package): update elastic-apm-http-client to version 9.0.0 <a href="https://github.com/elastic/apm-agent-nodejs/pull/1419" class="ulink" target="_top">#1419</a>
</li>
<li class="listitem">
perf: cache <em>ids</em> value of transactions and spans <a href="https://github.com/elastic/apm-agent-nodejs/pull/1434" class="ulink" target="_top">#1434</a>
</li>
</ul>
</div>
<h5><a id="_bug_fixes_11"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
fix: always end transaction when socket is closed prematurely <a href="https://github.com/elastic/apm-agent-nodejs/pull/1439" class="ulink" target="_top">#1439</a>
</li>
<li class="listitem">
fix: change logUncaughtExceptions default to false <a href="https://github.com/elastic/apm-agent-nodejs/pull/1432" class="ulink" target="_top">#1432</a>
</li>
<li class="listitem">
fix: write stack trace of uncaught exceptions to STDERR <a href="https://github.com/elastic/apm-agent-nodejs/pull/1429" class="ulink" target="_top">#1429</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-3.0.0"></a>3.0.0 - 2019/9/30<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes_2"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/master/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
feat: allow manual instrumentation with <code class="literal">instrument: false</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1114" class="ulink" target="_top">#1114</a>
</li>
<li class="listitem">
feat: allow setting span/transaction <code class="literal">type</code>, <code class="literal">subtype</code>, and <code class="literal">action</code> separately (the behavior of the old <code class="literal">type</code> has changed) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1292" class="ulink" target="_top">#1292</a>
</li>
<li class="listitem">
feat: use <code class="literal">external</code> as span type instead of <code class="literal">ext</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1291" class="ulink" target="_top">#1291</a>
</li>
<li class="listitem">
refactor(graphql): use custom transaction type <code class="literal">graphql</code> for graphql requests instead of <code class="literal">request</code> <a href="https://github.com/elastic/apm-agent-nodejs/pull/1245" class="ulink" target="_top">#1245</a>
</li>
<li class="listitem">
feat(http): add <code class="literal">instrumentIncomingHTTPRequests</code> config (<code class="literal">disableInstrumentations</code> now behaves differently) <a href="https://github.com/elastic/apm-agent-nodejs/pull/1298" class="ulink" target="_top">#1298</a>
</li>
<li class="listitem">
chore: remove deprecated APIs <a href="https://github.com/elastic/apm-agent-nodejs/pull/1413" class="ulink" target="_top">#1413</a>
</li>
<li class="listitem">
chore: drop support for older Node.js versions <a href="https://github.com/elastic/apm-agent-nodejs/pull/1383" class="ulink" target="_top">#1383</a>
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-2.x.html">Node.js Agent version 2.x »</a>
</span>
</div>
</div>
</body>
</html>
